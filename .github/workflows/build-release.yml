name: Build & Release Design Tokens

on:
  push:
    branches:
      - main
    paths:
      - "token.json"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      
      - name: Install deps
        run: npm ci

      - name: Clean and build
        run: |
          rm -rf build/
          npm run build:tokens
      
      - name: Check for build changes
        id: check_changes
        run: |
          git add build
          
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No build changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Build changes detected"
          fi
      
      - name: Commit and push build
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git commit -m "chore: build design tokens"
          
          # ë²„ì „ ì—…ë°ì´íŠ¸ (íƒœê·¸ ì¶©ëŒ ë°©ì§€)
          npm version patch --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          
          git add package.json package-lock.json
          git commit -m "chore: release v${NEW_VERSION}"
          
          # íƒœê·¸ ìƒì„±
          NEW_TAG="v${NEW_VERSION}"
          git tag -f $NEW_TAG -m "Release $NEW_TAG"
          
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          
          # í‘¸ì‹œ (ì»¤ë°‹ 2ê°œ + íƒœê·¸)
          git push https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git HEAD:main
          git push https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git $NEW_TAG --force
      
      - name: Create GitHub Release
        if: steps.check_changes.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: Release ${{ env.NEW_TAG }}
          body: |
            ### ğŸ¨ Design Tokens Updated
            
            **Changes:**
            - token.json ë³€ê²½ ë°˜ì˜
            - Design tokens ìë™ ë¹Œë“œ
            
            **Generated Files:**
            - ğŸ iOS Color Sets (`build/ios/`)
            - ğŸ¤– Android XML (`build/android/`)
            - ğŸ“¦ SCSS Variables (`build/scss/`)
            - âš›ï¸ React Components (`build/compose/`)
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}